generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  
}

model appointment_slots {
  id                  Int                  @id @default(autoincrement())
  availability_id     Int?
  appointment_time    DateTime             @db.Time(6)
  is_booked           Boolean?             @default(false)
  appointment_id      Int?
  created_at          DateTime?            @default(now()) @db.Timestamp(6)
  updated_at          DateTime?            @default(now()) @db.Timestamp(6)
  appointments        appointments?        @relation(fields: [appointment_id], references: [id], onUpdate: NoAction)
  doctor_availability doctor_availability? @relation(fields: [availability_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([availability_id, appointment_time])
  @@index([availability_id, is_booked], map: "idx_appointment_slots_availability")
}

model appointments {
  id                Int                 @id @default(autoincrement())
  user_id           Int?
  doctor_id         Int
  availability_id   Int?
  patient_name      String              @db.VarChar(255)
  patient_phone     String              @db.VarChar(15)
  patient_email     String?             @db.VarChar(255)
  patient_nic       String?             @db.VarChar(20)
  patient_dob       DateTime?           @db.Date
  patient_gender    String?             @db.VarChar(10)
  patient_age       Int?
  slt_phone         String?             @db.VarChar(15)
  notes             String?
  appointment_date  DateTime            @db.Date
  appointment_time  DateTime            @db.Time(6)
  payment_method    String?             @default("bill") @db.VarChar(50)
  total_amount      Decimal             @db.Decimal(10, 2)
  is_member         Boolean?            @default(false)
  send_sms          Boolean?            @default(true)
  send_email        Boolean?            @default(false)
  status            String?             @default("confirmed") @db.VarChar(50)
  doctor_name       String?             @db.VarChar(255)
  specialty         String?             @db.VarChar(255)
  hospital          String?             @db.VarChar(255)
  refund_eligible   Boolean?            @default(false)
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  updated_at        DateTime?           @default(now()) @db.Timestamp(6)
  cancellation_date DateTime?           @db.Timestamp(6)
  cancelled_by      Int?
  appointment_slots appointment_slots[]
  users             users?              @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payments          payments[]
  refunds           refunds[]
}

model doctor_availability {
  id                  Int                 @id @default(autoincrement())
  doctor_id           Int
  start_time          DateTime            @db.Time(6)
  end_time            DateTime            @db.Time(6)
  booked_appointments Int?                @default(0)
  is_active           Boolean?            @default(true)
  max_appointments    Int?                @default(10)
  availability_date   DateTime?           @db.Date
  appointment_slots   appointment_slots[]
  doctors             doctors             @relation(fields: [doctor_id], references: [id], onDelete: NoAction, onUpdate: NoAction) // ADD THIS LINE

  @@index([doctor_id, availability_date, is_active], map: "idx_doctor_availability_date")
}

model doctors {
  id                  Int                   @id @default(autoincrement())
  name                String                @db.VarChar(255)
  specialty           String                @db.VarChar(255)
  hospital            String                @db.VarChar(255)
  hospital_type       String                @db.VarChar(50)
  city                String                @db.VarChar(255)
  is_active           Boolean?              @default(true)
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  consultation_fee    Decimal?              @default(3000) @db.Decimal(10, 2)
  doctor_availability doctor_availability[] // ADD THIS LINE
}

model payments {
  id             Int           @id @default(autoincrement())
  appointment_id Int?
  payment_method String?       @db.VarChar(50)
  amount         Decimal?      @db.Decimal(10, 2)
  payment_status String?       @default("pending") @db.VarChar(50)
  created_at     DateTime?     @default(now()) @db.Timestamp(6)
  updated_at     DateTime?     @default(now()) @db.Timestamp(6)
  transaction_id String?       @db.VarChar(255)
  refund_date    DateTime?     @db.Timestamp(6)
  refund_amount  Decimal?      @db.Decimal(10, 2)
  appointments   appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model refunds {
  id             Int           @id @default(autoincrement())
  appointment_id Int?
  user_id        Int?
  amount         Decimal?      @db.Decimal(10, 2)
  status         String?       @default("pending") @db.VarChar(50)
  refund_reason  String?
  created_at     DateTime?     @default(now()) @db.Timestamp(6)
  appointments   appointments? @relation(fields: [appointment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users          users?        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  id            Int            @id @default(autoincrement())
  name          String         @db.VarChar(255)
  email         String         @unique @db.VarChar(255)
  phone         String?        @db.VarChar(20)
  password_hash String         @db.VarChar(255)
  role          String         @db.VarChar(50)
  is_active     Boolean?       @default(true)
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  updated_at    DateTime?      @default(now()) @db.Timestamp(6)
  is_suspended  Boolean?       @default(false)
  appointments  appointments[]
  refunds       refunds[]
}
